<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="多线程,">










<meta name="description" content="之前很早介绍过一些多线程的基础文章，这次主要就多线程同步机制这一块来进行讲解…..">
<meta name="keywords" content="多线程">
<meta property="og:type" content="article">
<meta property="og:title" content="多线程编程之线程同步机制">
<meta property="og:url" content="http://yoursite.com/2018/06/06/多线程编程之线程同步机制/index.html">
<meta property="og:site_name" content="goxcheer个人小栈">
<meta property="og:description" content="之前很早介绍过一些多线程的基础文章，这次主要就多线程同步机制这一块来进行讲解…..">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2020-03-02T07:45:24.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="多线程编程之线程同步机制">
<meta name="twitter:description" content="之前很早介绍过一些多线程的基础文章，这次主要就多线程同步机制这一块来进行讲解…..">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/06/06/多线程编程之线程同步机制/">





  <title>多线程编程之线程同步机制 | goxcheer个人小栈</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">goxcheer个人小栈</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">一叶知秋意，一树识菩提</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/06/多线程编程之线程同步机制/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="goxcheer">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="goxcheer个人小栈">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">多线程编程之线程同步机制</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-06-06T09:51:49+08:00">
                2018-06-06
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/多线程/" itemprop="url" rel="index">
                    <span itemprop="name">多线程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>之前很早介绍过一些多线程的基础文章，这次主要就多线程同步机制这一块来进行讲解…..</p>
<a id="more"></a>
<h1 id="锁概述"><a href="#锁概述" class="headerlink" title="锁概述"></a>锁概述</h1><p>多线程并发访问资源的时候，会出现线程安全的问题。我们可以将并发访问转换为串行，即一个共享数据一次只能一个线程访问。锁就是利用这种思路来保障线程安全的。</p>
<p>一个线程在访问共享数据之前需要获取锁，访问结束之后必须要释放锁，一个锁一次只能被一个线程持有。<strong>锁的持有线程在获取锁和释放锁之间执行的代码称为临界区</strong>.</p>
<blockquote>
<p>JAVA虚拟机将锁划分为内部锁(intrinsic Lock)和显示锁(Explicit Lock). 内部锁通过<code>synchronized</code>关键字实现的，显式锁是用<br><code>java.concurrent.locks.Lock</code>接口的实现类实现的。</p>
</blockquote>
<h2 id="可重入"><a href="#可重入" class="headerlink" title="可重入"></a>可重入</h2><p>一个线程在持有该锁的的时候能否再次申请该锁，能的话就是<strong>重入锁(Reentrant)</strong>，否则就是<strong>非重入锁(No-Reentrant)</strong>.<br>伪代码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">methodA</span><span class="params">()</span></span>&#123;</span><br><span class="line">  acquireLock();</span><br><span class="line">  methodB();</span><br><span class="line">  realeseLock();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">methodB</span><span class="params">()</span></span>&#123;</span><br><span class="line"> acquireLock();</span><br><span class="line"> realeseLock();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>方法A获取锁的同时调用方法B，方法B同时也去获取锁，如果也成功，则该锁是可重入的。</p>
<blockquote>
<p>可重入锁可以理解为一个对象，该对象包含一个计数器，获取一次锁计数器+1，释放一次锁，计数器-1.一个可重入锁的线程第一次获取锁的时候开销较大，因为第一次必须要与其它线程’竞争’来获取锁.</p>
</blockquote>
<h2 id="锁的争用与调度"><a href="#锁的争用与调度" class="headerlink" title="锁的争用与调度"></a>锁的争用与调度</h2><p>锁可以看做多线程应用访问共享数据的一种排他性资源，因此，资源的争用，调度对锁也适用。</p>
<p>java平台中锁的调用策略包括<strong>公平策略</strong>和<strong>非公平策略</strong>,相应的锁称为<strong>公平锁</strong>和<strong>非公平锁</strong>.<br>内部锁属于非公平的锁，显示锁既支持公平锁又支持非公平的锁。</p>
<h1 id="内部锁Synchronized"><a href="#内部锁Synchronized" class="headerlink" title="内部锁Synchronized"></a>内部锁Synchronized</h1><h2 id="互斥对象锁"><a href="#互斥对象锁" class="headerlink" title="互斥对象锁"></a>互斥对象锁</h2><p>java平台中任何一个对象都有一个唯一与之关联的锁，被称为<strong>监视器(monitor)</strong>或者<strong>内部锁(intrinsic Lock)</strong>,内部锁是通过<br><strong>synchronized</strong>来实现的。</p>
<p>在多线程环境下，可能存在多个线程共享数据，当需要同一时刻有且只有一个线程操作共享数据，其它线程等待该线程处理完数据后再进行，此时就需要给该资源的对象加上<strong>互斥锁</strong>。</p>
<p>在 <code>Java</code>中，关键字<code>synchronized</code>可以保证在同一个时刻，只有一个线程可以执行某个方法或者某个代码块(主要是对方法或者代码块中存在共享数据的操作)，同时我们还应该注意到<code>synchronized</code>另外一个重要的作用，<code>synchronized</code>可保证一个线程的变化(主要是共享数据的变化)被其他线程所看到（<strong>保证可见性</strong>）。</p>
<p>首先来看一段代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SynchonizedExample1</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span>  <span class="keyword">void</span> <span class="title">add1</span><span class="params">(<span class="keyword">int</span> num)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            log.info(<span class="string">"add1,i=&#123;&#125;,num=&#123;&#125;"</span>, i, num);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SynchonizedExample1 example = <span class="keyword">new</span> SynchonizedExample1();</span><br><span class="line">        ExecutorService executor = Executors.newCachedThreadPool();</span><br><span class="line">        executor.execute(()-&gt;&#123;</span><br><span class="line">            example.add1(<span class="number">1</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        executor.execute(()-&gt;&#123;</span><br><span class="line">            example.add1(<span class="number">2</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 这段代码通过<code>Executors</code>线程池创建了2个线程，同时创建了一个<code>Example</code>实例对象，在2个线程中都执行<code>example</code>对象的add1方法，只是传入的参数不同。<br> 结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">21</span>:<span class="number">31</span>:<span class="number">44.164</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">0</span>,num=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">31</span>:<span class="number">44.164</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">0</span>,num=<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">31</span>:<span class="number">44.172</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">1</span>,num=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">31</span>:<span class="number">44.172</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">1</span>,num=<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">31</span>:<span class="number">44.172</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">2</span>,num=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">31</span>:<span class="number">44.172</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">2</span>,num=<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">31</span>:<span class="number">44.172</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">3</span>,num=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">31</span>:<span class="number">44.172</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">3</span>,num=<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">31</span>:<span class="number">44.172</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">4</span>,num=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">31</span>:<span class="number">44.172</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">5</span>,num=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">31</span>:<span class="number">44.172</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">6</span>,num=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">31</span>:<span class="number">44.172</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">4</span>,num=<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">31</span>:<span class="number">44.172</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">7</span>,num=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">31</span>:<span class="number">44.172</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">5</span>,num=<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">31</span>:<span class="number">44.172</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">8</span>,num=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">31</span>:<span class="number">44.172</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">6</span>,num=<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">31</span>:<span class="number">44.172</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">9</span>,num=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">31</span>:<span class="number">44.172</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">7</span>,num=<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">31</span>:<span class="number">44.172</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">8</span>,num=<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">31</span>:<span class="number">44.172</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">9</span>,num=<span class="number">2</span></span><br></pre></td></tr></table></figure>
<p><strong>执行后可以看到2个线程是交替执行add1() 方法的</strong>。<br><strong>说明至此对象并没有被某个线程加锁</strong>。</p>
<p>下面将<code>add1()</code>方法稍作修改。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">add1</span><span class="params">(<span class="keyword">int</span> num)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        log.info(<span class="string">"add1,i=&#123;&#125;,num=&#123;&#125;"</span>, i, num);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>结果：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">21</span>:<span class="number">38</span>:<span class="number">19.097</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">0</span>,num=<span class="number">1</span></span><br><span class="line"><span class="number">21</span>:<span class="number">38</span>:<span class="number">19.107</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">1</span>,num=<span class="number">1</span></span><br><span class="line"><span class="number">21</span>:<span class="number">38</span>:<span class="number">19.107</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">2</span>,num=<span class="number">1</span></span><br><span class="line"><span class="number">21</span>:<span class="number">38</span>:<span class="number">19.107</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">3</span>,num=<span class="number">1</span></span><br><span class="line"><span class="number">21</span>:<span class="number">38</span>:<span class="number">19.107</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">4</span>,num=<span class="number">1</span></span><br><span class="line"><span class="number">21</span>:<span class="number">38</span>:<span class="number">19.107</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">5</span>,num=<span class="number">1</span></span><br><span class="line"><span class="number">21</span>:<span class="number">38</span>:<span class="number">19.107</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">6</span>,num=<span class="number">1</span></span><br><span class="line"><span class="number">21</span>:<span class="number">38</span>:<span class="number">19.107</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">7</span>,num=<span class="number">1</span></span><br><span class="line"><span class="number">21</span>:<span class="number">38</span>:<span class="number">19.107</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">8</span>,num=<span class="number">1</span></span><br><span class="line"><span class="number">21</span>:<span class="number">38</span>:<span class="number">19.107</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">9</span>,num=<span class="number">1</span></span><br><span class="line"><span class="number">21</span>:<span class="number">38</span>:<span class="number">19.107</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">0</span>,num=<span class="number">2</span></span><br><span class="line"><span class="number">21</span>:<span class="number">38</span>:<span class="number">19.107</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">1</span>,num=<span class="number">2</span></span><br><span class="line"><span class="number">21</span>:<span class="number">38</span>:<span class="number">19.107</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">2</span>,num=<span class="number">2</span></span><br><span class="line"><span class="number">21</span>:<span class="number">38</span>:<span class="number">19.107</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">3</span>,num=<span class="number">2</span></span><br><span class="line"><span class="number">21</span>:<span class="number">38</span>:<span class="number">19.107</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">4</span>,num=<span class="number">2</span></span><br><span class="line"><span class="number">21</span>:<span class="number">38</span>:<span class="number">19.107</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">5</span>,num=<span class="number">2</span></span><br><span class="line"><span class="number">21</span>:<span class="number">38</span>:<span class="number">19.107</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">6</span>,num=<span class="number">2</span></span><br><span class="line"><span class="number">21</span>:<span class="number">38</span>:<span class="number">19.107</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">7</span>,num=<span class="number">2</span></span><br><span class="line"><span class="number">21</span>:<span class="number">38</span>:<span class="number">19.107</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">8</span>,num=<span class="number">2</span></span><br><span class="line"><span class="number">21</span>:<span class="number">38</span>:<span class="number">19.107</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample1 - add1,i=<span class="number">9</span>,num=<span class="number">2</span></span><br></pre></td></tr></table></figure></p>
<p>可以看到线程1执行完后线程2才继续执行。<br>说明此时对象依次被线程加锁了。<br>作用于同步代码块：<br>同时<code>synchonized</code>也可以作用于同步代码块。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">add2</span><span class="params">(<span class="keyword">int</span> num)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            log.info(<span class="string">"add1,i=&#123;&#125;,num=&#123;&#125;"</span>, i, num);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>优点：这样不用在整个方法中加锁，只需要在需要加锁的代码内加锁，加锁会影响效率。<br>下面再看一段代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SynchonizedExample2</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">add1</span><span class="params">(<span class="keyword">int</span> num)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            log.info(<span class="string">"add1,i=&#123;&#125;,num=&#123;&#125;"</span>, i, num);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">add2</span><span class="params">(<span class="keyword">int</span> num)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                log.info(<span class="string">"add1,i=&#123;&#125;,num=&#123;&#125;"</span>, i, num);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SynchonizedExample2 example1 = <span class="keyword">new</span> SynchonizedExample2();</span><br><span class="line">        SynchonizedExample2 example2 = <span class="keyword">new</span> SynchonizedExample2();</span><br><span class="line">        ExecutorService executor = Executors.newCachedThreadPool();</span><br><span class="line">        executor.execute(()-&gt;&#123;</span><br><span class="line">            example1.add1(<span class="number">1</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        executor.execute(()-&gt;&#123;</span><br><span class="line">            example2.add1(<span class="number">2</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>分别创建2个对象2个线程，每个对象分别执行某一个线程的方法,结果：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">运行结果：</span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">46</span>:<span class="number">06.020</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample2 - add1,i=<span class="number">0</span>,num=<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">46</span>:<span class="number">06.021</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample2 - add1,i=<span class="number">0</span>,num=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">46</span>:<span class="number">06.029</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample2 - add1,i=<span class="number">1</span>,num=<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">46</span>:<span class="number">06.029</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample2 - add1,i=<span class="number">2</span>,num=<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">46</span>:<span class="number">06.029</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample2 - add1,i=<span class="number">1</span>,num=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">46</span>:<span class="number">06.029</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample2 - add1,i=<span class="number">3</span>,num=<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">46</span>:<span class="number">06.029</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample2 - add1,i=<span class="number">4</span>,num=<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">46</span>:<span class="number">06.029</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample2 - add1,i=<span class="number">2</span>,num=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">46</span>:<span class="number">06.029</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample2 - add1,i=<span class="number">5</span>,num=<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">46</span>:<span class="number">06.029</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample2 - add1,i=<span class="number">6</span>,num=<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">46</span>:<span class="number">06.029</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample2 - add1,i=<span class="number">3</span>,num=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">46</span>:<span class="number">06.029</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample2 - add1,i=<span class="number">7</span>,num=<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">46</span>:<span class="number">06.029</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample2 - add1,i=<span class="number">4</span>,num=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">46</span>:<span class="number">06.029</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample2 - add1,i=<span class="number">8</span>,num=<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">46</span>:<span class="number">06.029</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample2 - add1,i=<span class="number">5</span>,num=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">46</span>:<span class="number">06.029</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample2 - add1,i=<span class="number">9</span>,num=<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">46</span>:<span class="number">06.029</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample2 - add1,i=<span class="number">6</span>,num=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">46</span>:<span class="number">06.029</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample2 - add1,i=<span class="number">7</span>,num=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">46</span>:<span class="number">06.029</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample2 - add1,i=<span class="number">8</span>,num=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">46</span>:<span class="number">06.029</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO com.qgx.concurrency.example.sync.SynchonizedExample2 - add1,i=<span class="number">9</span>,num=<span class="number">1</span></span><br></pre></td></tr></table></figure></p>
<p>可以看到方法也是交替进行的。</p>
<p><strong>说明Synchonized只是一个对象的锁。，对于不同的对象的同一个类的方法，是无法使其互斥访问的。</strong></p>
<h2 id="保证可见性"><a href="#保证可见性" class="headerlink" title="保证可见性"></a>保证可见性</h2><p>JMM关于<code>synchronized</code>的两条规定：</p>
<p>　　1）线程解锁前，必须把共享变量的最新值刷新到主内存中</p>
<p>　　2）线程加锁时，将清空工作内存中共享变量的值，从而使用共享变量时需要从主内存中重新获取最新的值</p>
<p>　　　（注意：加锁与解锁需要是同一把锁）</p>
<p> 通过以上两点，可以看到synchronized能够实现可见性。</p>
<h1 id="显式锁"><a href="#显式锁" class="headerlink" title="显式锁"></a>显式锁</h1><h2 id="显式锁的实例"><a href="#显式锁的实例" class="headerlink" title="显式锁的实例"></a>显式锁的实例</h2><p>显示锁是自JDK1.5引入的排他锁，作用和内部锁相同，提供了一些内部锁不具备的特性，但并不是内部锁的替代品。</p>
<p>显示锁(Explicit Lock)是<code>java.util.concurrent.lock.Locks</code>接口的实例，默认实现是<code>ReentrantLock</code>.</p>
<p>下面代码演示锁的实例。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> num = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Lock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">increase</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">try</span>&#123;</span><br><span class="line">			lock.lock();</span><br><span class="line">			num++;</span><br><span class="line">		&#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">			lock.unlock();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		ExecutorService executorService = Executors.newFixedThreadPool(<span class="number">1000</span>);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">1000</span>; i++)&#123;</span><br><span class="line">			executorService.execute(()-&gt;&#123;</span><br><span class="line">				increase();</span><br><span class="line">			&#125;);</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println(num);</span><br><span class="line">		executorService.shutdown();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在访问共享变量前申请锁，Lock.lock(),一般共享数据访问结束之后需要释放锁，为了避免锁泄露，一般在Finally中执行。</p>
<h2 id="显示锁的调度"><a href="#显示锁的调度" class="headerlink" title="显示锁的调度"></a>显示锁的调度</h2><p><code>ReentrantLock</code>既支持公平锁也支持非公平锁。<code>ReentrantLock</code>内部提供一个构造器来创建是否公平的锁.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReentrantLock</span><span class="params">(<span class="keyword">boolean</span> fair)</span> </span>&#123;</span><br><span class="line">       sync = fair ? <span class="keyword">new</span> FairSync() : <span class="keyword">new</span> NonfairSync();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p><code>FairSync</code>和<code>NonfairSync</code>两个内部类分别为公平和非公平的实现策略。</p>
<p>公平锁保障锁的调度的公平性往往增加了一些线程暂停和唤醒的措施，因此开销较大，适用于锁持有时间较长或者线程申请锁的平均时间较长。因此，显示锁默认是非公平策略的。</p>
<h2 id="改进型锁-读写锁"><a href="#改进型锁-读写锁" class="headerlink" title="改进型锁:读写锁"></a>改进型锁:读写锁</h2><p>锁的排他性使得多个线程没法安全的读取共享变量(只是读取而不是更新)，这不利于提高系统的并发性。</p>
<blockquote>
<p>对于同步在同一锁上的线程而言，对共享变量仅读取而没有进行更新的线程称为只读线程，对共享变量除了读取还有更新操作的线程称为写线程。</p>
</blockquote>
<p><strong>读写锁(Read/Write Lock)</strong>是一种改进的排他锁，也被称为共享/排他锁。<strong>读写锁允许多个线程同时读取共享变量，一次只允许一个线程对共享变量进行读取更新操作</strong>。任何线程读取共享变量的时候，其它线程无法更新这些变量;一个线程更新共享变量的时候，其它线程无法访问该变量。</p>
<p>读写锁的功能是通过—读锁和写锁实现的。读锁是共享锁，可以被多个读线程持有，写锁是排他锁，一次只能被一个线程持有。</p>
<table>
<thead>
<tr>
<th>类别</th>
<th>获得条件</th>
<th>排他性</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>读锁</td>
<td>相应的写锁未被任何线程持有</td>
<td>对读线程是共享，对写线程是排他的</td>
<td>允许多个线程同时读取共享变量，保障其它线程不能够更新共享变量</td>
</tr>
<tr>
<td>写锁</td>
<td>该写锁未被任何线程持有并且相应的读锁未被任何线程持有</td>
<td>对写线程和读线程均排他</td>
<td>使得写线程已独占的方式访问共享变量</td>
</tr>
</tbody>
</table>
<p>读写锁应用：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ReentrantReadWriteLock readWriteLock = <span class="keyword">new</span> ReentrantReadWriteLock();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ReentrantReadWriteLock.ReadLock readLock = readWriteLock.readLock();</span><br><span class="line">    <span class="keyword">private</span> ReentrantReadWriteLock.WriteLock writeLock = readWriteLock.writeLock();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title">read</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            readLock.lock();</span><br><span class="line">            <span class="comment">//读取共享变量操作</span></span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            readLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title">write</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            writeLock.lock();</span><br><span class="line">            <span class="comment">//读取共享变量操作</span></span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            writeLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="轻量级同步机制：volatile关键字"><a href="#轻量级同步机制：volatile关键字" class="headerlink" title="轻量级同步机制：volatile关键字"></a>轻量级同步机制：volatile关键字</h1><p><code>volatile</code>这个关键字可能很多朋友都听说过，或许也都用过。在Java 5之前，它是一个备受争议的关键字，因为在程序中使用它往往会导致出人意料的结果。在Java 5之后，<code>volatile</code>关键字才得以重获生机。</p>
<blockquote>
<p>一旦一个共享变量（类的成员变量、类的静态成员变量）被volatile修饰之后，那么就具备了两层语义：<br>    1）保证了不同线程对这个变量进行操作时的可见性，即一个线程修改了某个变量的值，这新值对其他线程来说是立即可见的。<br>    2）禁止进行指令重排序。</p>
</blockquote>
<p><strong>即volatile关键字主要在多线程环境下保证变量的可见性和有序性。</strong></p>
<h2 id="保证可见性-1"><a href="#保证可见性-1" class="headerlink" title="保证可见性"></a>保证可见性</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo01</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span>  Boolean flag = <span class="keyword">false</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class="line">        executorService.execute(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">while</span> (!flag) &#123;</span><br><span class="line">                System.out.println(<span class="string">"你好！"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        executorService.execute(()-&gt;&#123;</span><br><span class="line">            flag = <span class="keyword">true</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码定义了两个线程，<br>一般情况是线程1在属于不确定的“你好”之后，就会被线程2中断。</p>
<p>也许在大多数时候，这个代码能够把线程中断，但是也有可能会导致无法中断线程（虽然这个可能性很小，但是只要一旦发生这种情况就会造成死循环了）。</p>
<p>下面解释一下这段代码为何有可能导致无法中断线程。在前面已经解释过，每个线程在运行过程中都有自己的工作内存，那么线程1在运行的时候，会将stop变量的值拷贝一份放在自己的工作内存当中。</p>
<p> 那么当线程2更改了stop变量的值之后，但是还没来得及写入主存当中，线程2转去做其他事情了，那么线程1由于不知道线程2对stop变量的更改，因此还会一直循环下去。</p>
<p>   但是用<code>volatile</code>修饰之后就变得不一样了：</p>
<p>　　第一：使用<code>volatile</code>关键字会强制将修改的值立即写入主存；</p>
<p>　　第二：使用<code>volatile</code>关键字的话，当线程2进行修改时，会导致线程1的工作内存中缓存变量stop的缓存行无效（反映到硬件层的话，就是CPU的L1或者L2缓存中对应的缓存行无效）；</p>
<p>　　第三：由于线程1的工作内存中缓存变量stop的缓存行无效，所以线程1再次读取变量stop的值时会去主存读取。</p>
<p>　　那么在线程2修改stop值时（当然这里包括2个操作，修改线程2工作内存中的值，然后将修改后的值写入内存），会使得线程1的工作内存中缓存变量stop的缓存行无效，然后线程1读取时，发现自己的缓存行无效，它会等待缓存行对应的主存地址被更新之后，然后去对应的主存读取最新的值。</p>
<p>　　那么线程1读取到的就是最新的正确的值.</p>
<h2 id="保证有序性"><a href="#保证有序性" class="headerlink" title="保证有序性"></a>保证有序性</h2><p>在前面提到<code>volatile</code>关键字能禁止指令重排序，所以<code>volatile</code>能在一定程度上保证有序性。</p>
<p>　　<code>volatile</code>关键字禁止指令重排序有两层意思：</p>
<p>　　1）当程序执行到<code>volatile</code>变量的读操作或者写操作时，在其前面的操作的更改肯定全部已经进行，且结果已经对后面的操作可见；在其后面的操作肯定还没有进行；</p>
<p>　　2）在进行指令优化时，不能将在对<code>volatile</code>变量访问的语句放在其后面执行，也不能把<code>volatile</code>变量后面的语句放到其前面执行。</p>
<p>前面讲述了源于<code>volatile</code>关键字的一些使用，下面我们来探讨一下<code>volatile</code>到底如何保证可见性和禁止指令重排序的。</p>
<p>　　下面这段话摘自《深入理解Java虚拟机》：</p>
<p>　　“观察加入volatile关键字和没有加入volatile关键字时所生成的汇编代码发现，加入volatile关键字时，会多出一个lock前缀指令”</p>
<p>　　lock前缀指令实际上相当于一个内存屏障（也成内存栅栏），内存屏障会提供3个功能：</p>
<p>　　1）它确保指令重排序时不会把其后面的指令排到内存屏障之前的位置，也不会把前面的指令排到内存屏障的后面；即在执行到内存屏障这句指令时，在它前面的操作已经全部完成；</p>
<p>　　2）它会强制将对缓存的修改操作立即写入主存；</p>
<p>　　3）如果是写操作，它会导致其他CPU中对应的缓存行无效。</p>
<h1 id="CAS与原子变量"><a href="#CAS与原子变量" class="headerlink" title="CAS与原子变量"></a>CAS与原子变量</h1><h2 id="什么是CAS"><a href="#什么是CAS" class="headerlink" title="什么是CAS"></a>什么是CAS</h2><p>CAS(compare and swap)是一种处理器的指令,不少多线程的java标准类库实现最终都是借助CAS.</p>
<p>我们之前利用<code>Synchronized</code>实现这样一段代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">increment</span><span class="params">()</span></span>&#123;</span><br><span class="line"> <span class="keyword">synchronized</span>(<span class="keyword">this</span>)&#123;</span><br><span class="line">	 count++;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里利用锁来保障原子性显得有些杀鸡用牛刀的样子!锁的开销很大，使得程序执行效率较低。<code>Volatile</code>关键字虽然开销小，但是没办法保证<code>count++</code>这种操作的原子性.</p>
<p>因此，我们可以利用上面说的处理器指令层面的CAS来解决这种场景下的原子性问题.</p>
<p>伪代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> count;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">increment</span><span class="params">()</span></span>&#123;</span><br><span class="line">  Long oldValue;</span><br><span class="line">  Long newValue;</span><br><span class="line">  <span class="keyword">do</span>&#123;</span><br><span class="line">		oldValue = count;</span><br><span class="line">		newValue = oldValue++;</span><br><span class="line">		<span class="keyword">while</span> (！compareAndSwap(oldValue,newValue)); <span class="comment">//调用CAS来更新共享变量</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>每次在循环体中读取count的值，然后+1，然后调用CAS视图去更新count值，如果count更新失败，即在更新count期间其它线程修改了count的值，则继续尝试，直到更新成功。</p>
<p>CAS只是保障了原子性，并没有保障可见性，所以还需要用volatile来修饰变量。</p>
<h2 id="原子变量类"><a href="#原子变量类" class="headerlink" title="原子变量类"></a>原子变量类</h2><p>自JDK1.5，java提供了基于CAS实现的原子变量类。</p>
<table>
<thead>
<tr>
<th>分组</th>
<th>类</th>
</tr>
</thead>
<tbody>
<tr>
<td>基础数据型</td>
<td>AtomicInteger、AtomicLong、AtomicBoolean</td>
</tr>
<tr>
<td>数组型</td>
<td>AtomicIntegerArray、AtomicLongArray、AtomicReferenceArray</td>
</tr>
<tr>
<td>字段更新器</td>
<td>AtomicIntegerFieldUpdater、AtomicLongFieldUpdater、AtomicReferenceFieldUpdater</td>
</tr>
<tr>
<td>引用型</td>
<td>AtomicReference、AtomicStampedReference、AtomicMarkableReference</td>
</tr>
</tbody>
</table>
<p>下面列举一个简单的例子实现轻量级的锁保障。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AtomicInteger count = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//自增</span></span><br><span class="line">        count.incrementAndGet();</span><br><span class="line">        System.out.println(count.get());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Test test = <span class="keyword">new</span> Test();</span><br><span class="line">        test.add();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/多线程/" rel="tag"># 多线程</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/06/05/多线程之生命周期与相互协作/" rel="next" title="多线程之生命周期与相互协作">
                <i class="fa fa-chevron-left"></i> 多线程之生命周期与相互协作
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/06/12/理解hash/" rel="prev" title="理解hash">
                理解hash <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">goxcheer</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">133</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">56</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">84</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#锁概述"><span class="nav-number">1.</span> <span class="nav-text">锁概述</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#可重入"><span class="nav-number">1.1.</span> <span class="nav-text">可重入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#锁的争用与调度"><span class="nav-number">1.2.</span> <span class="nav-text">锁的争用与调度</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#内部锁Synchronized"><span class="nav-number">2.</span> <span class="nav-text">内部锁Synchronized</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#互斥对象锁"><span class="nav-number">2.1.</span> <span class="nav-text">互斥对象锁</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#保证可见性"><span class="nav-number">2.2.</span> <span class="nav-text">保证可见性</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#显式锁"><span class="nav-number">3.</span> <span class="nav-text">显式锁</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#显式锁的实例"><span class="nav-number">3.1.</span> <span class="nav-text">显式锁的实例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#显示锁的调度"><span class="nav-number">3.2.</span> <span class="nav-text">显示锁的调度</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#改进型锁-读写锁"><span class="nav-number">3.3.</span> <span class="nav-text">改进型锁:读写锁</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#轻量级同步机制：volatile关键字"><span class="nav-number">4.</span> <span class="nav-text">轻量级同步机制：volatile关键字</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#保证可见性-1"><span class="nav-number">4.1.</span> <span class="nav-text">保证可见性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#保证有序性"><span class="nav-number">4.2.</span> <span class="nav-text">保证有序性</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CAS与原子变量"><span class="nav-number">5.</span> <span class="nav-text">CAS与原子变量</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#什么是CAS"><span class="nav-number">5.1.</span> <span class="nav-text">什么是CAS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#原子变量类"><span class="nav-number">5.2.</span> <span class="nav-text">原子变量类</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2017-2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">goxcheer</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
